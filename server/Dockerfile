FROM node:alpine

WORKDIR "/server"

COPY ./package.json .

COPY ./package-lock.json .

RUN npm install

RUN npm install -g sequelize-cli

COPY . .

# app secret vars
ARG HASH_SECRET
ARG PAY_KEY_ID
ARG PAY_KEY_SECRET
ARG EMAIL_USER
ARG EMAIL_PASS
ARG AES_KEY
ARG RECAPTCHA_SECRET
ARG GOOGLE_CLIENT_ID
ARG GOOGLE_CLIENT_SECRET
ARG ORIGIN 
ARG NODE_ENV

# AWS RDS vars
ARG DB_NAME
ARG DB_USER
ARG DB_PASS
ARG DB_HOST

# set app config option
ENV PORT=4000
ENV DB_DIALECT=mysql
ENV DB_PORT=3306

ENV DB_NAME $DB_NAME
ENV DB_USER $DB_USER
ENV DB_PASS $DB_PASS
ENV DB_HOST $DB_HOST
ENV HASH_SECRET $HASH_SECRET
ENV PAY_KEY_ID $PAY_KEY_ID
ENV PAY_KEY_SECRET $PAY_KEY_SECRET
ENV EMAIL_USER $EMAIL_USER
ENV EMAIL_PASS $EMAIL_PASS
ENV AES_KEY $AES_KEY
ENV RECAPTCHA_SECRET $RECAPTCHA_SECRET
ENV GOOGLE_CLIENT_ID $GOOGLE_CLIENT_ID
ENV GOOGLE_CLIENT_SECRET $GOOGLE_CLIENT_SECRET
ENV ORIGIN $ORIGIN
ENV NODE_ENV $NODE_ENV

EXPOSE 4000

COPY ./docker-entrypoint-prod.sh ./docker-entrypoint-prod.sh

RUN chmod +x ./docker-entrypoint-prod.sh

ENTRYPOINT ["./docker-entrypoint-prod.sh"]